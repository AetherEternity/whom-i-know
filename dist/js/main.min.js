String.prototype.format?console.error("String.prototype.format already exists"):String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,r){return"undefined"!=typeof e[r]?e[r]:t})};var httpUtils={getParam:function(e){var t=window.location.hash.substring(1),r=t.split("&"),n=r.filter(function(t){return t.split("=")[0]===e}).map(function(e){return e.split("=")[1]});return n.length>1?n:n[0]}},search=function(){var e="https://api.vk.com/method/users.get?uids={0}&fields=sex,bdate,photo_100,education&callback=?",t="https://api.vk.com/method/friends.get?user_id={0}&callback=?",r=function(){return new function(){var e=[],t=[];this.add=function(r){return e.push(r.name),t.push(r),this},this.search=function(r){var n=e.indexOf(r),a=t[n];return a&&a.name!==r?void console.error("search.newTree.search - Нарушение целостности структуры данных (incorrect index)"):a},this.getTree=function(){return t},this.toString=function(){return JSON.stringify(t)},this.getCount=function(){return t.length}}};return{getUsers:function(t,r,n){""===t?n():(t=t.toString().split(",").map(function(e){return Number(e)||e}),t=t.filter(function(e,t,r){return r.indexOf(e)==t}),$.getJSON(e.format(t),function(e){r(e.error?!1:e.response)}))},getFriends:function(e,r,n){$.getJSON(t.format(e),function(e){r(e.response)}).fail(function(e){n(),console.log(e)})},buildTree:function(e,t){search=this;var n=e.depth,a=e.name;return void 0===a||""===a?(console.error("search.buildTree - Пустое имя (options.name)"),void t()):void 0===n||0>=n?(console.error("search.buildTree - Не задана глубина обхода (options.depth)"),void t()):void search.getUsers(a,function(e){var a=1,o=e[0].uid,i=r();return i.add({name:o,data:{depth:1}}),1===n?void t(i):void function s(e,r){var o=arguments;search.getFriends(e[e.length-1],function(u){u&&(r>1&&(a+=u.length),u.forEach(function(t){i.add({name:t,data:{parents:e,depth:n-r}}),r>1&&s(e.concat(t),r-1)})),o=void 0,a-=1,0===a&&t(i)},function(){s.call(void 0,o),o=void 0})}([o],n-1)})},findCommonUsers:function(e,t,r){search=this;var n=t.depth,a=t.name;if(void 0===a||""===a)return console.error("search.findCommonUsers - Пустое имя (options.name)"),void r();if(void 0===n||0>=n)return console.error("search.findCommonUsers - Не задана глубина обхода (options.depth)"),void r();var o=[];search.getUsers(a,function(t){var a=1,i=t[0].uid;!function s(t,n){var i=arguments;search.getFriends(t[t.length-1],function(u){u&&(n>2&&(a+=u.length),u.forEach(function(r){var a=e.search(r);if(a){var i=(a.data.parents||[]).concat(a.name).concat(t.slice().reverse());o.push(i)}n>2&&s(t.concat(r),n-1)})),a-=1,i=void 0,0===a&&r(o)},function(e){s.call(void 0,i),i=void 0})}([i],n)})},convert:function(e,t){if(void 0===e||0===e.length)return void t();var r;r=e.length>1?e.reduce(function(e,t){return e<t.length?e:t.length}):e[0].length,e=e.filter(function(e,t){return e.length===r}),e=e.filter(function(e,t,r){return 0===r.filter(function(r,n){return t>n&&e.every(function(t,n){return e[n]===r[n]})}).length}),search.getUsers(e,function(r){t({sequences:e,users:r})})}}}(),ui=function(){return{progress:function(e){var t=$("div.search-result-bar");if(0===t.length)return!1;var r=t.find(".progress-bar");return 0===r.length?!1:(100===e?(t.removeClass("progress-mode"),r.width(0)):(t.addClass("progress-mode"),r.width(e+"%")),!0)},notFound:function(){var e=$("#emptyModal");return 0===e.length?!1:(e.modal(),!0)},enableModes:function(){var e=$("div.search-result-bar label.btn");return 0===e.length?!1:(e.removeClass("disabled"),!0)},searchOn:function(){var e=$(".search-button button");return 0===e.length?!1:(e.removeAttr("disabled"),!0)},searchOff:function(){var e=$(".search-button button");return 0===e.length?!1:(e.attr("disabled","disabled"),!0)},count:function(e){var t=$(".search-button button.dropdown-toggle span.count");return 0===t.length?!1:void 0===e?t.text():(t.text(e),!0)},clean:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.removeClass("has-success"),t.removeClass("has-error");var r=t.find("span.glyphicon");return 0===r.length?!1:(r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-remove"),r.removeClass("glyphicon-refresh"),!0)},correct:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.addClass("has-success"),t.removeClass("has-error");var r=t.find("span.glyphicon");return 0===r.length?!1:(r.addClass("glyphicon-ok"),r.removeClass("glyphicon-remove"),r.removeClass("glyphicon-refresh"),!0)},incorrect:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.addClass("has-error"),t.removeClass("has-success");var r=t.find("span.glyphicon");return 0===r.length?!1:(r.addClass("glyphicon-remove"),r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-refresh"),!0)},lookForUser:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.removeClass("has-success"),t.removeClass("has-error");var r=t.find("span.glyphicon");return 0===r.length?!1:(r.addClass("glyphicon-refresh"),r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-remove"),!0)},panel:{changePanel:function(e){var t=$("div.result-panels div.result-panel#"+e);return 0===t.length?!1:($("div.result-panels div.result-panel").removeClass("active"),t.addClass("active"),!0)},count:function(e){var t=e.sequences[0]?e.sequences[0].length-2:"до хрена",r=$("div.result-panels div.result-panel#count");if(0===r.length)return!1;r.empty();var n=$("<div>");n.addClass("empty-row");var a=$("<div>");$.each(Array(t),function(){var e=$("<span>");e.addClass("glyphicon glyphicon-user count-icon"),a.append(e)});var o=$("<div>"),i="1"===String(t).slice(-1)?"пользователя":"пользователей";return o.append("<span>Вы знакомы через "+t+" "+i+"</span>"),r.append(n,a,o),!0},write:function(e){var t=$("div.result-panels div.result-panel ul.list-group");return 0===t.length?!1:(t.find("li.list-group-item").remove(),e.sequences.forEach(function(r){r=r.map(function(t){return e.users.filter(function(e){return e.uid===t})[0]});var n=$('<li class="list-group-item">'),a=$("<table>");n.append(a);var o=$("<tr>");a.append(o),r.forEach(function(e){var t='title="<img src={0}><div>Пол: {1}</div><div>ДР: {2}</div></div>"'.format(e.photo_100,2===e.sex?"мужской":1===e.sex?"женский":"не говорит",e.bdate),r='href="http://vk.com/id{0}"'.format(e.uid);o.append('<td><a target="_blank" '+t+" "+r+">"+[e.first_name,e.last_name].join(" ")+"</a></td>")}),t.append(n)}),t.find("[title]").tooltip({html:!0}),!0)},draw:function(e){var t=$("div.result-panels div.result-panel#draw");t.empty();var r,n,a=e.sequences[0];a&&(r=a[0],n=a[a.length-1]);var o=[];e.sequences.forEach(function(e){e.reduce(function(e,t){return o.push([e,t]),t})}),o=o.filter(function(e,t){return 0===o.filter(function(r,n){return t>n&&e[0]===r[0]&&e[1]===r[1]}).length});var i=o.map(function(e){return{source:e[0],target:e[1]}}),s={};i.forEach(function(t){var r=e.users.filter(function(e){return e.uid===t.source})[0];t.source=s[t.source]||(s[t.source]={name:t.source,label:[r.first_name,r.last_name].join(" ")});var n=e.users.filter(function(e){return e.uid===t.target})[0];t.target=s[t.target]||(s[t.target]={name:t.target,label:[n.first_name,n.last_name].join(" ")})});var u=t.closest(".container").width(),c=.6*u,l=d3.layout.force().nodes(d3.values(s)).links(i).size([u,c]).linkDistance(150).charge(-100).on("tick",function(){f.attr("d",function(e){return"M"+e.source.x+","+e.source.y+" "+e.target.x+","+e.target.y}),h.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),p.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}).start(),d=d3.select("div.result-panels div.result-panel#draw").append("svg").attr("width",u).attr("height",c);d.append("defs").selectAll("marker").data(["suit","licensing","resolved"]).enter().append("marker").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-1.5).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");var f=d.append("g").selectAll("path").data(l.links()).enter().append("path").attr("class",function(e){return"link"}),h=d.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr("r",8).attr("class",function(e){return e.name===r||e.name===n?"red":void 0}).call(l.drag),p=d.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr("x",12).attr("y",3).text(function(e){return e.label})}}}}();$(document).ready(function(){var e=parseInt(httpUtils.getParam("length"))||4;ui.count(e);var t=[],r=$("input#first");r.bind("keyup",function(e){ui.lookForUser(r),search.getUsers(e.target.value,function(n){switch(n){case!1:ui.incorrect(r),t[0]=void 0;break;default:ui.correct(r),t[0]=e.target.value}t[0]&&t[1]&&t[0]!==t[1]?ui.searchOn():ui.searchOff()},function(){ui.searchOff(),ui.clean(r),t[0]=void 0})});var n=$("input#second");n.bind("keyup",function(e){ui.lookForUser(n),search.getUsers(e.target.value,function(r){switch(r){case!1:ui.incorrect(n),t[1]=void 0;break;default:ui.correct(n),t[1]=e.target.value}t[0]&&t[1]&&t[0]!==t[1]?ui.searchOn():ui.searchOff()},function(){ui.searchOff(),ui.clean(n),t[1]=void 0})}),$("input").keyup(),$(".search-button ul.dropdown-menu a").click(function(t){e=$(t.target).data("length"),location.hash="length="+e,ui.count(e)}),$("label.btn-radio").bind("change",function(e){ui.panel.changePanel($(e.target).data("panel"))}),$("button#search").click(function(){var r=(e+1)/2;t[0]!==t[1]&&(ui.progress(0),search.buildTree({name:t[0],depth:Math.ceil(r)},function(e){ui.progress(30);var n={name:t[1],depth:Math.floor(r)};search.findCommonUsers(e,n,function(e){ui.progress(80),search.convert(e,function(e){ui.progress(90),e?(ui.panel.write(e),ui.panel.count(e),ui.panel.draw(e),ui.enableModes()):ui.notFound(),ui.progress(100)})})}))})});